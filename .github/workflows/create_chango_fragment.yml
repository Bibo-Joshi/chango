name: Create Chango Fragment
on:
  pull_request:
    branches:
      - main
    # types:
    #   - opened
    #   - reopened

jobs:
  create-chango-fragment:
    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write
    name: create-chango-fragment
    runs-on: ubuntu-latest
    steps:

      - name: Fetch Linked Issues & Parent PR
        id: fetch-linked-issues
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea # v7.0.1
        with:
          script: |
            const pullRequest = context.payload.pull_request;
            const octokit = context.octokit;
            
            // debug-print the context
            console.log(JSON.stringify(context, null, 2));
            
            // Fetch the linked issues
            const { data } = await github.graphql(`
              query {
                repository(owner:"${context.repo.owner}", name:"${context.repo.repo}") {
                  pullRequest(number:${context.payload.pullRequest.number}) {
                    closingIssuesReferences(first: 100) {
                      nodes {
                        number
                        title
                        labels(first: 100) {
                          nodes {
                            name
                            id
                          }
                        }
                      }
                    }
                  }
                }
              }
            `);
            const closingIssues = data.repository.pullRequest.closingIssuesReferences.nodes.map(node => {
              return {
                number: node.number,
                title: node.title,
                labels: node.labels.nodes.map(label => label.name)
              };
            });
            
            // Fetch the parent PR
            const { response } = await github.graphql(`
              query {
                search(type: ISSUE, query: "is:open is:pr base:main head:${context.payload.pull_request.base.ref}", first: 100) {
                  issueCount
                  nodes {
                    ... on PullRequest {
                      number
                      title
                      url
                      state
                    }
                  }
                }
              }
            `);
            const prs = response.search.nodes;
            const parentPR = prs.length > 0 ? prs[0] : null;
            
            // Combine the linked issues and the parent PR to a single JSON object
            const linkedIssuesAndParentPR = {
              linked_issues: closingIssues,
              parent_pull_request: parentPR
            };
            core.setOutput('data', JSON.stringify(linkedIssuesAndParentPR));

      # Create the new fragment
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          persist-credentials: false
      - uses: ./
        with:
          data: ${{ steps.fetch-linked-issues.outputs.data }}

